esphome: 
  name: "e1-pro-multi-sense"
  friendly_name: "E1 Pro Multi Sense"
  name_add_mac_suffix: true
  project:
    name: "Sensy-One.E1 Pro Multi Sense" 
    version: "v1.0.0 (ETH)"  

  on_boot: 
    - priority: 600
      then: 
        - if: 
            condition: 
              lambda: 'return !id(onboarding_done);'
            then: 
              - light.turn_on: 
                  id: ws2812_LED
                  effect: "Purple Breathing"
            else: 
              - lambda: '/* NaN */'

    - priority: 750
      then: 
        - if: 
            condition: 
              switch.is_on: ble_proxy_switch
            then: 
              - lambda: |-
                  id(bt_proxy).set_active(true);
              - esp32_ble_tracker.start_scan:
                  id: ble_tracker
            else: 
              - esp32_ble_tracker.stop_scan:
                  id: ble_tracker
              - lambda: |-
                  id(bt_proxy).set_active(false);

    - priority: 800
      then:
        - lambda: |-
            if (!isnan(id(scd40_temp_offset).state)) {
              id(scd40_sensor)->set_temperature_offset((float) id(scd40_temp_offset).state);
            }

    - priority: 900
      then:
        - delay: 4s
        - lambda: |-
            id(e1_sensor).query_all_settings();

script:
  - id: finish_onboarding
    mode: restart
    then:
      - light.turn_on:
          id: ws2812_LED
          red: 100%
          green: 0%
          blue: 30% 
          brightness: 100%
      - delay: 2s
      - light.turn_off: ws2812_LED
      - lambda: 'id(onboarding_done) = true;'

external_components:
  - source:
      type: local
      path: components

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_BOOTLOADER_APP_ROLLBACK_ENABLE: n

ethernet:
  type: W5500
  mosi_pin: GPIO1
  miso_pin: GPIO10
  clk_pin: GPIO4
  cs_pin: GPIO8
  reset_pin: GPIO2
  interrupt_pin: GPIO3
  clock_speed: 10MHz

# wifi:
#   ap:
#     ssid: "I am Sensy!"
#     ap_timeout: 1min

captive_portal: 

esp32_ble_tracker:
  id: ble_tracker
  scan_parameters:
    interval: 320ms
    window: 300ms
    active: true

bluetooth_proxy:
  id: bt_proxy
  active: false

logger:
  level: NONE

api:
  reboot_timeout: 0s
  on_client_connected:
    then:
      - if:
          condition:
            lambda: 'return !id(onboarding_done);'
          then:
            - script.execute: finish_onboarding
          else:
            - lambda: '/* NaN */'

ota:
  - platform: web_server

web_server:
  version: 3

uart:
  id: uart_bus
  tx_pin: GPIO21
  rx_pin: GPIO20
  baud_rate: 115200
  rx_buffer_size: 4096 

i2c:
  id: i2c_bus
  sda: GPIO5
  scl: GPIO6
  scan: false

output:
  - platform: ledc
    id: mlt8530_buzzer
    pin: GPIO7
    frequency: 2700 Hz
    inverted: false

globals:
  - id: onboarding_done
    type: bool
    restore_value: true
    initial_value: 'false'

light:
  - platform: esp32_rmt_led_strip
    name: "WS2812 | LED"
    entity_category: config
    id: ws2812_LED
    chipset: WS2812
    pin: GPIO0
    num_leds: 14
    rgb_order: GRB
    restore_mode: RESTORE_DEFAULT_OFF
    effects:
      - addressable_lambda:
          name: "Purple Breathing"
          update_interval: 50ms
          lambda: |-
            static float phase = 0.0f;
            phase += 0.02f;
            if (phase > 1.0f) phase -= 1.0f;
            float s = (sinf(phase * 2.0f * 3.14159f) + 1.0f) * 0.5f;
            float brightness = s * 0.85f + 0.15f;
            uint8_t r = (uint8_t)(brightness * 220.0f);
            uint8_t g = 0;
            uint8_t b = (uint8_t)(brightness * 255.0f);
            for (size_t i = 0; i < it.size(); i++) {
              it[i] = Color(r, g, b);
            }

button:
  - platform: factory_reset
    name: "ESP32 | Factory Reset"
    id: factory_reset_btn
    entity_category: config
    icon: mdi:factory

  - platform: restart
    name: "ESP32 | Restart Module"
    id: restart_btn
    entity_category: config
    icon: mdi:restart

  - platform: template
    name: "SCD40 | Forced Calibration"
    id: scd40_forced_calibration_btn
    icon: "mdi:tune"
    entity_category: config
    on_press:
      - scd4x.perform_forced_calibration:
          id: scd40_sensor
          value: 426           

  - platform: template
    name: "SCD40 | Factory Reset"
    id: scd40_factory_reset_btn
    icon: "mdi:factory"
    entity_category: config
    on_press:
      - scd4x.factory_reset: scd40_sensor
      - delay: 250ms
      - button.press: restart_btn

  - platform: template
    name: "RADAR | Restart Module"
    id: radar_restart_btn
    icon: "mdi:restart"
    entity_category: config
    on_press:
      - lambda: |-
          id(e1_sensor).send_restart();
      - delay: 4s
      - lambda: |-
          id(e1_sensor).query_all_settings();

  - platform: template
    name: "RADAR | Factory Reset"
    id: radar_factory_reset_btn
    icon: "mdi:factory"
    entity_category: config
    on_press:
      - lambda: |-
          id(e1_sensor).send_factory_reset();
      - delay: 4s
      - lambda: |-
          id(e1_sensor).query_all_settings();

select:
  - platform: template
    name: "RADAR | Installation Method"
    id: radar_installation_method
    icon: "mdi:axis-arrow"
    entity_category: config
    options:
      - "Side"
      - "Top"
    optimistic: true
    set_action:
      - lambda: |-
          bool to_top = (x == "Top");
          id(e1_sensor).send_set_installation_mode(to_top);
      - delay: 4s
      - lambda: |-
          id(e1_sensor).query_all_settings();

  - platform: template
    name: "RADAR | (side) Angle"
    id: radar_installation_angle
    icon: "mdi:format-text-rotation-angle-down"
    entity_category: config
    options:
      - "0"
      - "1"
      - "2"
      - "3"
      - "4"
      - "5"
      - "6"
      - "7"
      - "8"
      - "9"
      - "10"
      - "11"
      - "12"
      - "13"
      - "14"
      - "15"
      - "16"
      - "17"
      - "18"
      - "19"
      - "20"
      - "21"
      - "22"
      - "23"
      - "24"
      - "25"
      - "26"
      - "27"
      - "28"
      - "29"
      - "30"
    optimistic: true
    set_action:
      - lambda: |-
          if (id(radar_installation_method).state == "Side") {
            float angle = atof(x.c_str());
            float height = atof(id(radar_installation_height).state.c_str());
            id(e1_sensor).send_set_installation_params(height, angle);
          }
      - lambda: |-
                id(e1_sensor).send_restart();

  - platform: template
    name: "RADAR | (side) Height"
    id: radar_installation_height
    icon: "mdi:arrow-up-down"
    entity_category: config
    options:
      - "0"
      - "1.6"
      - "1.7"
      - "1.8"
      - "1.9"
      - "2.0"
      - "2.1"
      - "2.2"
      - "2.3"
      - "2.4"
      - "2.5"
      - "2.6"
    optimistic: true
    set_action:
      - lambda: |-
          if (x == "0") return;
          if (id(radar_installation_method).state == "Side") {
            float height = atof(x.c_str());
            float angle = atof(id(radar_installation_angle).state.c_str());
            id(e1_sensor).send_set_installation_params(height, angle);
          }
      - lambda: |-
          id(e1_sensor).send_restart();

  - platform: template
    name: "RADAR | Detection Sensitivity"
    id: radar_sensitivity
    icon: "mdi:tune-vertical"
    entity_category: config
    options:
      - "High"
      - "Medium"
      - "Low"
    optimistic: true
    set_action:
      - lambda: |-
          uint8_t val = 0;
          if (x == "High") val = 0x01;
          else if (x == "Medium") val = 0x02;
          else if (x == "Low") val = 0x03;
          if (val != 0) {
            id(e1_sensor).send_set_sensitivity(val);
          }
      - lambda: |-
          id(e1_sensor).send_restart();      

switch:
  - platform: template
    id: buzzer_switch
    name: "MLT8530 | Buzzer"
    icon: mdi:surround-sound
    entity_category: config
    optimistic: true
    turn_on_action:
      - output.ledc.set_frequency:
          id: mlt8530_buzzer
          frequency: !lambda 'return (uint32_t) id(buzzer_pitch_hz).state;'
      - output.set_level:
          id: mlt8530_buzzer
          level: !lambda 'return id(buzzer_volume).state;'
    turn_off_action:
      - output.set_level:
          id: mlt8530_buzzer
          level: 0.0

  - platform: template
    id: ble_proxy_switch
    name: "BLE | Proxy"
    icon: mdi:bluetooth
    entity_category: config
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    turn_on_action:
      - lambda: |-
          id(bt_proxy).set_active(true);
      - esp32_ble_tracker.start_scan:
          id: ble_tracker
    turn_off_action:
      - esp32_ble_tracker.stop_scan:
          id: ble_tracker
      - lambda: |-
          id(bt_proxy).set_active(false);

sensor:
  - platform: e1_pro
    id: e1_sensor
    installation_method: radar_installation_method
    installation_angle: radar_installation_angle
    installation_height: radar_installation_height
    detection_sensitivity: radar_sensitivity
    side_range: radar_side_range
    top_range: radar_top_range
    target1_x:
      name: "Target 1 X"
      id: target1_x
      icon: mdi:alpha-x-box-outline
      unit_of_measurement: "cm"
    target1_y:
      name: "Target 1 Y"
      id: target1_y
      icon: mdi:alpha-y-box-outline
      unit_of_measurement: "cm"
    target1_angle:
      name: "Target 1 Angle"
      id: target1_angle
      icon: mdi:format-text-rotation-angle-up
      unit_of_measurement: "°"
    target1_distance:
      name: "Target 1 Distance"
      id: target1_distance
      icon: mdi:map-marker-distance
      unit_of_measurement: "cm"
    target2_x:
      name: "Target 2 X"
      id: target2_x
      icon: mdi:alpha-x-box-outline
      unit_of_measurement: "cm"
    target2_y:
      name: "Target 2 Y"
      id: target2_y
      icon: mdi:alpha-y-box-outline
      unit_of_measurement: "cm"
    target2_angle:
      name: "Target 2 Angle"
      id: target2_angle
      icon: mdi:format-text-rotation-angle-up
      unit_of_measurement: "°"
    target2_distance:
      name: "Target 2 Distance"
      id: target2_distance
      icon: mdi:map-marker-distance
      unit_of_measurement: "cm"
    target3_x:
      name: "Target 3 X"
      id: target3_x
      icon: mdi:alpha-x-box-outline
      unit_of_measurement: "cm"
    target3_y:
      name: "Target 3 Y"
      id: target3_y
      icon: mdi:alpha-y-box-outline
      unit_of_measurement: "cm"
    target3_angle:
      name: "Target 3 Angle"
      id: target3_angle
      icon: mdi:format-text-rotation-angle-up
      unit_of_measurement: "°"
    target3_distance:
      name: "Target 3 Distance"
      id: target3_distance
      icon: mdi:map-marker-distance
      unit_of_measurement: "cm"
    target4_x:
      name: "Target 4 X"
      id: target4_x
      icon: mdi:alpha-x-box-outline
      unit_of_measurement: "cm"
    target4_y:
      name: "Target 4 Y"
      id: target4_y
      icon: mdi:alpha-y-box-outline
      unit_of_measurement: "cm"
    target4_angle:
      name: "Target 4 Angle"
      id: target4_angle
      icon: mdi:format-text-rotation-angle-up
      unit_of_measurement: "°"
    target4_distance:
      name: "Target 4 Distance"
      id: target4_distance
      icon: mdi:map-marker-distance
      unit_of_measurement: "cm"
    target5_x:
      name: "Target 5 X"
      id: target5_x
      icon: mdi:alpha-x-box-outline
      unit_of_measurement: "cm"
    target5_y:
      name: "Target 5 Y"
      id: target5_y
      icon: mdi:alpha-y-box-outline
      unit_of_measurement: "cm"
    target5_angle:
      name: "Target 5 Angle"
      id: target5_angle
      icon: mdi:format-text-rotation-angle-up
      unit_of_measurement: "°"
    target5_distance:
      name: "Target 5 Distance"
      id: target5_distance
      icon: mdi:map-marker-distance
      unit_of_measurement: "cm"

    exclusion_zone_points_count: exclusion_zone_points_count

    exclusion_zone_p1_x: exclusion_zone_p1_x
    exclusion_zone_p1_y: exclusion_zone_p1_y
    exclusion_zone_p2_x: exclusion_zone_p2_x
    exclusion_zone_p2_y: exclusion_zone_p2_y
    exclusion_zone_p3_x: exclusion_zone_p3_x
    exclusion_zone_p3_y: exclusion_zone_p3_y
    exclusion_zone_p4_x: exclusion_zone_p4_x
    exclusion_zone_p4_y: exclusion_zone_p4_y
    exclusion_zone_p5_x: exclusion_zone_p5_x
    exclusion_zone_p5_y: exclusion_zone_p5_y
    exclusion_zone_p6_x: exclusion_zone_p6_x
    exclusion_zone_p6_y: exclusion_zone_p6_y
    exclusion_zone_p7_x: exclusion_zone_p7_x
    exclusion_zone_p7_y: exclusion_zone_p7_y
    exclusion_zone_p8_x: exclusion_zone_p8_x
    exclusion_zone_p8_y: exclusion_zone_p8_y

  - platform: template
    name: "All Targets Count"
    icon: mdi:counter
    id: all_targets_count
    unit_of_measurement: ""
    update_interval: 1s
    lambda: |-
      int count = 0;
      if (id(target1_distance).state > 0) count++;
      if (id(target2_distance).state > 0) count++;
      if (id(target3_distance).state > 0) count++;
      if (id(target4_distance).state > 0) count++;
      if (id(target5_distance).state > 0) count++;
      return count;

  - platform: template
    name: "Zone 1 Target Count"
    icon: mdi:counter
    id: zone1_target_count
    unit_of_measurement: ""
    update_interval: 1s
    lambda: |-
      const int MAX_PTS = 8;
      float xs[MAX_PTS], ys[MAX_PTS];
      int n = (int) id(zone1_points_count).state;
      if (n < 3) return 0;

      auto nz = [](float v){ return isnan(v) ? 0.0f : v; };
      xs[0]=nz(id(zone1_p1_x).state); ys[0]=nz(id(zone1_p1_y).state);
      xs[1]=nz(id(zone1_p2_x).state); ys[1]=nz(id(zone1_p2_y).state);
      xs[2]=nz(id(zone1_p3_x).state); ys[2]=nz(id(zone1_p3_y).state);
      xs[3]=nz(id(zone1_p4_x).state); ys[3]=nz(id(zone1_p4_y).state);
      xs[4]=nz(id(zone1_p5_x).state); ys[4]=nz(id(zone1_p5_y).state);
      xs[5]=nz(id(zone1_p6_x).state); ys[5]=nz(id(zone1_p6_y).state);
      xs[6]=nz(id(zone1_p7_x).state); ys[6]=nz(id(zone1_p7_y).state);
      xs[7]=nz(id(zone1_p8_x).state); ys[7]=nz(id(zone1_p8_y).state);
      if (n > MAX_PTS) n = MAX_PTS;

      // Ray-casting point-in-polygon
      auto in_poly = [&](float px, float py)->bool {
        bool inside = false;
        for (int i = 0, j = n - 1; i < n; j = i++) {
          bool inter = ((ys[i] > py) != (ys[j] > py)) &&
                      (px < (xs[j] - xs[i]) * (py - ys[i]) / ((ys[j]-ys[i]) == 0 ? 1e-6f : (ys[j]-ys[i])) + xs[i]);
          if (inter) inside = !inside;
        }
        return inside;
      };

      int count = 0;
      if (id(target1_distance).state > 0 && in_poly(id(target1_x).state, id(target1_y).state)) count++;
      if (id(target2_distance).state > 0 && in_poly(id(target2_x).state, id(target2_y).state)) count++;
      if (id(target3_distance).state > 0 && in_poly(id(target3_x).state, id(target3_y).state)) count++;
      if (id(target4_distance).state > 0 && in_poly(id(target4_x).state, id(target4_y).state)) count++;
      if (id(target5_distance).state > 0 && in_poly(id(target5_x).state, id(target5_y).state)) count++;
      return count;

  - platform: template
    name: "Zone 2 Target Count"
    icon: mdi:counter
    id: zone2_target_count
    unit_of_measurement: ""
    update_interval: 1s
    lambda: |-
      const int MAX_PTS = 8;
      float xs[MAX_PTS], ys[MAX_PTS];
      int n = (int) id(zone2_points_count).state;
      if (n < 3) return 0;

      auto nz = [](float v){ return isnan(v) ? 0.0f : v; };
      xs[0]=nz(id(zone2_p1_x).state); ys[0]=nz(id(zone2_p1_y).state);
      xs[1]=nz(id(zone2_p2_x).state); ys[1]=nz(id(zone2_p2_y).state);
      xs[2]=nz(id(zone2_p3_x).state); ys[2]=nz(id(zone2_p3_y).state);
      xs[3]=nz(id(zone2_p4_x).state); ys[3]=nz(id(zone2_p4_y).state);
      xs[4]=nz(id(zone2_p5_x).state); ys[4]=nz(id(zone2_p5_y).state);
      xs[5]=nz(id(zone2_p6_x).state); ys[5]=nz(id(zone2_p6_y).state);
      xs[6]=nz(id(zone2_p7_x).state); ys[6]=nz(id(zone2_p7_y).state);
      xs[7]=nz(id(zone2_p8_x).state); ys[7]=nz(id(zone2_p8_y).state);
      if (n > MAX_PTS) n = MAX_PTS;

      // Ray-casting point-in-polygon
      auto in_poly = [&](float px, float py)->bool {
        bool inside = false;
        for (int i = 0, j = n - 1; i < n; j = i++) {
          bool inter = ((ys[i] > py) != (ys[j] > py)) &&
                      (px < (xs[j] - xs[i]) * (py - ys[i]) / ((ys[j]-ys[i]) == 0 ? 1e-6f : (ys[j]-ys[i])) + xs[i]);
          if (inter) inside = !inside;
        }
        return inside;
      };

      int count = 0;
      if (id(target1_distance).state > 0 && in_poly(id(target1_x).state, id(target1_y).state)) count++;
      if (id(target2_distance).state > 0 && in_poly(id(target2_x).state, id(target2_y).state)) count++;
      if (id(target3_distance).state > 0 && in_poly(id(target3_x).state, id(target3_y).state)) count++;
      if (id(target4_distance).state > 0 && in_poly(id(target4_x).state, id(target4_y).state)) count++;
      if (id(target5_distance).state > 0 && in_poly(id(target5_x).state, id(target5_y).state)) count++;
      return count;

  - platform: template
    name: "Zone 3 Target Count"
    icon: mdi:counter
    id: zone3_target_count
    unit_of_measurement: ""
    update_interval: 1s
    lambda: |-
      const int MAX_PTS = 8;
      float xs[MAX_PTS], ys[MAX_PTS];
      int n = (int) id(zone3_points_count).state;
      if (n < 3) return 0;

      auto nz = [](float v){ return isnan(v) ? 0.0f : v; };
      xs[0]=nz(id(zone3_p1_x).state); ys[0]=nz(id(zone3_p1_y).state);
      xs[1]=nz(id(zone3_p2_x).state); ys[1]=nz(id(zone3_p2_y).state);
      xs[2]=nz(id(zone3_p3_x).state); ys[2]=nz(id(zone3_p3_y).state);
      xs[3]=nz(id(zone3_p4_x).state); ys[3]=nz(id(zone3_p4_y).state);
      xs[4]=nz(id(zone3_p5_x).state); ys[4]=nz(id(zone3_p5_y).state);
      xs[5]=nz(id(zone3_p6_x).state); ys[5]=nz(id(zone3_p6_y).state);
      xs[6]=nz(id(zone3_p7_x).state); ys[6]=nz(id(zone3_p7_y).state);
      xs[7]=nz(id(zone3_p8_x).state); ys[7]=nz(id(zone3_p8_y).state);
      if (n > MAX_PTS) n = MAX_PTS;

      // Ray-casting point-in-polygon
      auto in_poly = [&](float px, float py)->bool {
        bool inside = false;
        for (int i = 0, j = n - 1; i < n; j = i++) {
          bool inter = ((ys[i] > py) != (ys[j] > py)) &&
                      (px < (xs[j] - xs[i]) * (py - ys[i]) / ((ys[j]-ys[i]) == 0 ? 1e-6f : (ys[j]-ys[i])) + xs[i]);
          if (inter) inside = !inside;
        }
        return inside;
      };

      int count = 0;
      if (id(target1_distance).state > 0 && in_poly(id(target1_x).state, id(target1_y).state)) count++;
      if (id(target2_distance).state > 0 && in_poly(id(target2_x).state, id(target2_y).state)) count++;
      if (id(target3_distance).state > 0 && in_poly(id(target3_x).state, id(target3_y).state)) count++;
      if (id(target4_distance).state > 0 && in_poly(id(target4_x).state, id(target4_y).state)) count++;
      if (id(target5_distance).state > 0 && in_poly(id(target5_x).state, id(target5_y).state)) count++;
      return count;

  - platform: internal_temperature
    name: "ESP32 | Temperature"
    entity_category: diagnostic
    icon: mdi:thermometer

  - platform: scd4x
    id: scd40_sensor
    measurement_mode: periodic
    automatic_self_calibration: false
    ambient_pressure_compensation_source: bme280_pressure
    update_interval: 5s      
    co2:
      name: "SCD40 CO₂ Concentration"
      id: scd_co2
      icon: "mdi:molecule-co2"
      device_class: carbon_dioxide
      unit_of_measurement: "ppm"
      accuracy_decimals: 0
      state_class: measurement
    temperature:
      name: "SCD40 Temperature"
      id: scd40_temp
      unit_of_measurement: "°C"
      icon: "mdi:thermometer"
    humidity:
      name: "SCD40 Humidity"
      id: scd40_rh
      unit_of_measurement: "%"
      icon: "mdi:water-percent"

  - platform: bme280_i2c
    i2c_id: i2c_bus
    address: 0x76
    update_interval: 5s
    # temperature:
    #   name: "BME280 Temperature"
    #   id: bme280_temperature
    #   unit_of_measurement: "°C"
    # humidity:
    #   name: "BME280 Humidity"
    #   id: bme280_humidity
    #   unit_of_measurement: "%"
    pressure:
      name: "BME280 Pressure"
      id: bme280_pressure
      unit_of_measurement: "hPa"

  - platform: ltr390
    i2c_id: i2c_bus
    update_interval: 5s

    light:
      name: "LTR390 Ambient Light (lux)"
      id: ltr390_lux_raw
      icon: mdi:brightness-5
      filters:
        - lambda: |-
            if (isnan(x) || isnan(id(ltr390_lux_offset).state)) {
              return x;
            }
            return x + id(ltr390_lux_offset).state;

    uv_index:
      name: "LTR390 UV Index"
      id: ltr390_uv_raw
      icon: mdi:weather-sunset
      filters:
        - lambda: |-
            if (isnan(x) || isnan(id(ltr390_uv_offset).state)) {
              return x;
            }
            return x + id(ltr390_uv_offset).state;

    gain:
      ambient_light: X1
      uv: X1
    resolution:
      ambient_light: 20
      uv: 20
    window_correction_factor: 2.3

number:
  - platform: template
    name: "RADAR | (side) Range"
    id: radar_side_range
    icon: "mdi:signal-distance-variant"
    entity_category: config
    unit_of_measurement: "cm"
    min_value: 0
    max_value: 600
    step: 10
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
    on_value:
      - lambda: |-
          if (x == 0) return;
          if (id(radar_installation_method).state == "Side") {
            float range_m = x / 100.0f;
            id(e1_sensor).send_set_detection_range(range_m, -60.0f, 60.0f);
          }
      - lambda: |-
              id(e1_sensor).send_restart();

  - platform: template
    name: "RADAR | (top) Range"
    id: radar_top_range
    icon: "mdi:signal-distance-variant"
    entity_category: config
    unit_of_measurement: "cm"
    min_value: 0
    max_value: 400
    step: 10
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
    on_value:
      - lambda: |-
          if (x == 0) return;
          if (id(radar_installation_method).state == "Top") {
            float range_m = x / 100.0f;
            id(e1_sensor).send_set_detection_range(range_m, 0.0f, 360.0f);
          }
      - lambda: |-
                id(e1_sensor).send_restart();

  - platform: template
    name: "Any Presence Delay"
    icon: mdi:timer-outline
    id: presence_delay
    unit_of_measurement: "s"
    min_value: 0
    max_value: 3600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: exclusion_zone_points_count
    name: "Exclusion Zone Points Count"
    icon: mdi:counter
    unit_of_measurement: "pts"
    min_value: 0
    max_value: 8
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: exclusion_zone_p1_x
    name: "Exclusion Zone P1 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: exclusion_zone_p1_y
    name: "Exclusion Zone P1 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: exclusion_zone_p2_x
    name: "Exclusion Zone P2 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: exclusion_zone_p2_y
    name: "Exclusion Zone P2 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: exclusion_zone_p3_x
    name: "Exclusion Zone P3 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: exclusion_zone_p3_y
    name: "Exclusion Zone P3 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: exclusion_zone_p4_x
    name: "Exclusion Zone P4 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: exclusion_zone_p4_y
    name: "Exclusion Zone P4 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: exclusion_zone_p5_x
    name: "Exclusion Zone P5 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: exclusion_zone_p5_y
    name: "Exclusion Zone P5 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: exclusion_zone_p6_x
    name: "Exclusion Zone P6 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: exclusion_zone_p6_y
    name: "Exclusion Zone P6 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: exclusion_zone_p7_x
    name: "Exclusion Zone P7 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: exclusion_zone_p7_y
    name: "Exclusion Zone P7 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: exclusion_zone_p8_x
    name: "Exclusion Zone P8 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: exclusion_zone_p8_y
    name: "Exclusion Zone P8 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone1_points_count
    name: "Zone 1 Points Count"
    icon: mdi:counter
    unit_of_measurement: "pts"
    min_value: 0
    max_value: 8
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone1_p1_x
    name: "Zone 1 P1 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone1_p1_y
    name: "Zone 1 P1 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone1_p2_x
    name: "Zone 1 P2 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone1_p2_y
    name: "Zone 1 P2 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone1_p3_x
    name: "Zone 1 P3 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone1_p3_y
    name: "Zone 1 P3 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone1_p4_x
    name: "Zone 1 P4 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone1_p4_y
    name: "Zone 1 P4 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone1_p5_x
    name: "Zone 1 P5 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone1_p5_y
    name: "Zone 1 P5 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone1_p6_x
    name: "Zone 1 P6 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone1_p6_y
    name: "Zone 1 P6 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone1_p7_x
    name: "Zone 1 P7 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone1_p7_y
    name: "Zone 1 P7 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone1_p8_x
    name: "Zone 1 P8 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone1_p8_y
    name: "Zone 1 P8 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone1_presence_delay
    name: "Zone 1 Presence Delay"
    icon: mdi:timer-outline
    unit_of_measurement: "s"
    min_value: 0
    max_value: 3600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone2_points_count
    name: "Zone 2 Points Count"
    icon: mdi:counter
    unit_of_measurement: "pts"
    min_value: 0
    max_value: 8
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone2_p1_x
    name: "Zone 2 P1 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone2_p1_y
    name: "Zone 2 P1 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone2_p2_x
    name: "Zone 2 P2 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone2_p2_y
    name: "Zone 2 P2 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone2_p3_x
    name: "Zone 2 P3 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone2_p3_y
    name: "Zone 2 P3 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone2_p4_x
    name: "Zone 2 P4 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone2_p4_y
    name: "Zone 2 P4 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone2_p5_x
    name: "Zone 2 P5 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone2_p5_y
    name: "Zone 2 P5 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone2_p6_x
    name: "Zone 2 P6 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone2_p6_y
    name: "Zone 2 P6 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone2_p7_x
    name: "Zone 2 P7 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone2_p7_y
    name: "Zone 2 P7 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone2_p8_x
    name: "Zone 2 P8 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone2_p8_y
    name: "Zone 2 P8 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone2_presence_delay
    name: "Zone 2 Presence Delay"
    icon: mdi:timer-outline
    unit_of_measurement: "s"
    min_value: 0
    max_value: 3600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone3_points_count
    name: "Zone 3 Points Count"
    icon: mdi:counter
    unit_of_measurement: "pts"
    min_value: 0
    max_value: 8
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone3_p1_x
    name: "Zone 3 P1 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone3_p1_y
    name: "Zone 3 P1 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone3_p2_x
    name: "Zone 3 P2 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone3_p2_y
    name: "Zone 3 P2 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone3_p3_x
    name: "Zone 3 P3 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone3_p3_y
    name: "Zone 3 P3 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone3_p4_x
    name: "Zone 3 P4 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone3_p4_y
    name: "Zone 3 P4 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone3_p5_x
    name: "Zone 3 P5 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone3_p5_y
    name: "Zone 3 P5 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone3_p6_x
    name: "Zone 3 P6 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone3_p6_y
    name: "Zone 3 P6 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone3_p7_x
    name: "Zone 3 P7 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone3_p7_y
    name: "Zone 3 P7 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone3_p8_x
    name: "Zone 3 P8 X"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box
  - platform: template
    id: zone3_p8_y
    name: "Zone 3 P8 Y"
    icon: mdi:map-marker
    unit_of_measurement: "cm"
    min_value: -600
    max_value: 600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: zone3_presence_delay
    name: "Zone 3 Presence Delay"
    icon: mdi:timer-outline
    unit_of_measurement: "s"
    min_value: 0
    max_value: 3600
    step: 1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: ltr390_lux_offset
    name: "LTR390 Lux Offset"
    icon: mdi:brightness-5
    unit_of_measurement: "lux"
    min_value: -10000
    max_value: 10000
    step: 0.1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: ltr390_uv_offset
    name: "LTR390 UV Offset"
    icon: mdi:weather-sunset
    unit_of_measurement: "index"
    min_value: -50
    max_value: 50
    step: 0.1
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: box

  - platform: template
    id: buzzer_pitch_hz
    name: "MLT8530 Buzzer Pitch"
    icon: mdi:knob
    unit_of_measurement: "Hz"
    min_value: 100
    max_value: 8000
    step: 50
    initial_value: 2700
    optimistic: true
    restore_value: true
    mode: box
    on_value:
      - if:
          condition:
            switch.is_on: buzzer_switch
          then:
            - output.ledc.set_frequency:
                id: mlt8530_buzzer
                frequency: !lambda 'return (uint32_t) x;'

  - platform: template
    id: buzzer_volume
    name: "MLT8530 Buzzer Volume"
    icon: mdi:volume-high
    min_value: 0.0
    max_value: 1.0
    step: 0.01
    initial_value: 0.50
    optimistic: true
    restore_value: true
    mode: box
    on_value:
      - if:
          condition:
            switch.is_on: buzzer_switch
          then:
            - output.set_level:
                id: mlt8530_buzzer
                level: !lambda 'return x;'

  - platform: template
    id: scd40_temp_offset
    name: "SCD40 Temp Offset"
    icon: mdi:thermometer-plus
    unit_of_measurement: "°C"
    min_value: -50
    max_value: 50
    step: 0.01
    initial_value: 28.10
    optimistic: true
    restore_value: true
    mode: box
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            id(scd40_sensor)->set_temperature_offset((float) x);
          }

binary_sensor:
  - platform: status
    name: "ESP32 | Status"
    entity_category: diagnostic

  - platform: template
    name: "Any Presence"
    icon: mdi:home-account
    device_class: presence
    lambda: |-
      static unsigned long last_off = 0;
      bool present = id(target1_distance).state > 0 ||
                     id(target2_distance).state > 0 ||
                     id(target3_distance).state > 0 ||
                     id(target4_distance).state > 0 ||
                     id(target5_distance).state > 0;
      unsigned long now = millis();
      if (present) {
        last_off = now;
        return true;
      }
      return (now - last_off) < (unsigned long)(id(presence_delay).state * 1000.0);

  - platform: template
    name: "Zone 1 Presence"
    icon: mdi:home-account
    device_class: presence
    lambda: |-
      static unsigned long last_off_1 = 0;
      unsigned long now = millis();

      const int MAX_PTS = 8;
      float xs[MAX_PTS], ys[MAX_PTS];
      int n = (int) id(zone1_points_count).state;
      if (n < 3) return (now - last_off_1) < (unsigned long)(id(zone1_presence_delay).state * 1000.0);

      auto nz = [](float v){ return isnan(v) ? 0.0f : v; };
      xs[0]=nz(id(zone1_p1_x).state); ys[0]=nz(id(zone1_p1_y).state);
      xs[1]=nz(id(zone1_p2_x).state); ys[1]=nz(id(zone1_p2_y).state);
      xs[2]=nz(id(zone1_p3_x).state); ys[2]=nz(id(zone1_p3_y).state);
      xs[3]=nz(id(zone1_p4_x).state); ys[3]=nz(id(zone1_p4_y).state);
      xs[4]=nz(id(zone1_p5_x).state); ys[4]=nz(id(zone1_p5_y).state);
      xs[5]=nz(id(zone1_p6_x).state); ys[5]=nz(id(zone1_p6_y).state);
      xs[6]=nz(id(zone1_p7_x).state); ys[6]=nz(id(zone1_p7_y).state);
      xs[7]=nz(id(zone1_p8_x).state); ys[7]=nz(id(zone1_p8_y).state);
      if (n > MAX_PTS) n = MAX_PTS;

      auto in_poly = [&](float px, float py)->bool {
        bool inside = false;
        for (int i = 0, j = n - 1; i < n; j = i++) {
          bool inter = ((ys[i] > py) != (ys[j] > py)) &&
                      (px < (xs[j] - xs[i]) * (py - ys[i]) / ((ys[j]-ys[i]) == 0 ? 1e-6f : (ys[j]-ys[i])) + xs[i]);
          if (inter) inside = !inside;
        }
        return inside;
      };

      bool pres =
          (id(target1_distance).state > 0 && in_poly(id(target1_x).state, id(target1_y).state))
        || (id(target2_distance).state > 0 && in_poly(id(target2_x).state, id(target2_y).state))
        || (id(target3_distance).state > 0 && in_poly(id(target3_x).state, id(target3_y).state))
        || (id(target4_distance).state > 0 && in_poly(id(target4_x).state, id(target4_y).state))
        || (id(target5_distance).state > 0 && in_poly(id(target5_x).state, id(target5_y).state));

      if (pres) { last_off_1 = now; return true; }
      return (now - last_off_1) < (unsigned long)(id(zone1_presence_delay).state * 1000.0);

  - platform: template
    name: "Zone 2 Presence"
    icon: mdi:home-account
    device_class: presence
    lambda: |-
      static unsigned long last_off_2 = 0;
      unsigned long now = millis();

      const int MAX_PTS = 8;
      float xs[MAX_PTS], ys[MAX_PTS];
      int n = (int) id(zone2_points_count).state;
      if (n < 3) return (now - last_off_2) < (unsigned long)(id(zone2_presence_delay).state * 1000.0);

      auto nz = [](float v){ return isnan(v) ? 0.0f : v; };
      xs[0]=nz(id(zone2_p1_x).state); ys[0]=nz(id(zone2_p1_y).state);
      xs[1]=nz(id(zone2_p2_x).state); ys[1]=nz(id(zone2_p2_y).state);
      xs[2]=nz(id(zone2_p3_x).state); ys[2]=nz(id(zone2_p3_y).state);
      xs[3]=nz(id(zone2_p4_x).state); ys[3]=nz(id(zone2_p4_y).state);
      xs[4]=nz(id(zone2_p5_x).state); ys[4]=nz(id(zone2_p5_y).state);
      xs[5]=nz(id(zone2_p6_x).state); ys[5]=nz(id(zone2_p6_y).state);
      xs[6]=nz(id(zone2_p7_x).state); ys[6]=nz(id(zone2_p7_y).state);
      xs[7]=nz(id(zone2_p8_x).state); ys[7]=nz(id(zone2_p8_y).state);
      if (n > MAX_PTS) n = MAX_PTS;

      auto in_poly = [&](float px, float py)->bool {
        bool inside = false;
        for (int i = 0, j = n - 1; i < n; j = i++) {
          bool inter = ((ys[i] > py) != (ys[j] > py)) &&
                      (px < (xs[j] - xs[i]) * (py - ys[i]) / ((ys[j]-ys[i]) == 0 ? 1e-6f : (ys[j]-ys[i])) + xs[i]);
          if (inter) inside = !inside;
        }
        return inside;
      };

      bool pres =
          (id(target1_distance).state > 0 && in_poly(id(target1_x).state, id(target1_y).state))
        || (id(target2_distance).state > 0 && in_poly(id(target2_x).state, id(target2_y).state))
        || (id(target3_distance).state > 0 && in_poly(id(target3_x).state, id(target3_y).state))
        || (id(target4_distance).state > 0 && in_poly(id(target4_x).state, id(target4_y).state))
        || (id(target5_distance).state > 0 && in_poly(id(target5_x).state, id(target5_y).state));

      if (pres) { last_off_2 = now; return true; }
      return (now - last_off_2) < (unsigned long)(id(zone2_presence_delay).state * 1000.0);

  - platform: template
    name: "Zone 3 Presence"
    icon: mdi:home-account
    device_class: presence
    lambda: |-
      static unsigned long last_off_3 = 0;
      unsigned long now = millis();

      const int MAX_PTS = 8;
      float xs[MAX_PTS], ys[MAX_PTS];
      int n = (int) id(zone3_points_count).state;
      if (n < 3) return (now - last_off_3) < (unsigned long)(id(zone3_presence_delay).state * 1000.0);

      auto nz = [](float v){ return isnan(v) ? 0.0f : v; };
      xs[0]=nz(id(zone3_p1_x).state); ys[0]=nz(id(zone3_p1_y).state);
      xs[1]=nz(id(zone3_p2_x).state); ys[1]=nz(id(zone3_p2_y).state);
      xs[2]=nz(id(zone3_p3_x).state); ys[2]=nz(id(zone3_p3_y).state);
      xs[3]=nz(id(zone3_p4_x).state); ys[3]=nz(id(zone3_p4_y).state);
      xs[4]=nz(id(zone3_p5_x).state); ys[4]=nz(id(zone3_p5_y).state);
      xs[5]=nz(id(zone3_p6_x).state); ys[5]=nz(id(zone3_p6_y).state);
      xs[6]=nz(id(zone3_p7_x).state); ys[6]=nz(id(zone3_p7_y).state);
      xs[7]=nz(id(zone3_p8_x).state); ys[7]=nz(id(zone3_p8_y).state);
      if (n > MAX_PTS) n = MAX_PTS;

      auto in_poly = [&](float px, float py)->bool {
        bool inside = false;
        for (int i = 0, j = n - 1; i < n; j = i++) {
          bool inter = ((ys[i] > py) != (ys[j] > py)) &&
                      (px < (xs[j] - xs[i]) * (py - ys[i]) / ((ys[j]-ys[i]) == 0 ? 1e-6f : (ys[j]-ys[i])) + xs[i]);
          if (inter) inside = !inside;
        }
        return inside;
      };

      bool pres =
          (id(target1_distance).state > 0 && in_poly(id(target1_x).state, id(target1_y).state))
        || (id(target2_distance).state > 0 && in_poly(id(target2_x).state, id(target2_y).state))
        || (id(target3_distance).state > 0 && in_poly(id(target3_x).state, id(target3_y).state))
        || (id(target4_distance).state > 0 && in_poly(id(target4_x).state, id(target4_y).state))
        || (id(target5_distance).state > 0 && in_poly(id(target5_x).state, id(target5_y).state));

      if (pres) { last_off_3 = now; return true; }
      return (now - last_off_3) < (unsigned long)(id(zone3_presence_delay).state * 1000.0);